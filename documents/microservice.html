<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Jonny">
<title>Micro Service</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Micro Service</h1>
<div class="details">
<span id="author" class="author">Jonny</span><br>
<span id="revdate">Tuesday, 11 February, 2020</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Content</div>
<ul class="sectlevel1">
<li><a href="#_what_do_we_build">1. What do we build</a>
<ul class="sectlevel2">
<li><a href="#_product_service">1.1. Product service</a></li>
<li><a href="#_review_service">1.2. Review service</a></li>
<li><a href="#_recommendation_service">1.3. Recommendation service</a></li>
<li><a href="#_product_composite_service">1.4. Product composite service</a></li>
</ul>
</li>
<li><a href="#_start_all">2. Start ALL</a></li>
<li><a href="#_stop_all">3. STOP ALL</a></li>
<li><a href="#_find_application_used_specifing_port">4. Find application used specifing port</a></li>
<li><a href="#_curl_with_prety">5. Curl with prety</a></li>
<li><a href="#_preventing_slow_lookup_of_the_localhost_hostname">6. Preventing slow lookup of the localhost hostname</a></li>
<li><a href="#_adding_semi_automated_tests_of_a_microservice_landscape">7. Adding semi-automated tests of a microservice landscape</a></li>
<li><a href="#_semi_automatic_test_script">8. Semi Automatic Test Script</a></li>
<li><a href="#_knowing_how_many_core">9. Knowing how many core</a></li>
<li><a href="#_knowing_how_many_heap">10. Knowing how many heap</a></li>
<li><a href="#_cpu">11. CPU</a></li>
<li><a href="#_memory">12. Memory</a></li>
<li><a href="#_problems_with_docker_and_java_se_9_or_older">13. Problems with Docker and Java SE 9 (or older)</a></li>
<li><a href="#_building_a_docker_image">14. Building a Docker image</a></li>
<li><a href="#_starting_up_docker">15. Starting up Docker</a></li>
<li><a href="#_running_the_container_detached">16. Running the container detached</a></li>
<li><a href="#_docker_compose">17. Docker Compose</a></li>
<li><a href="#_testing_them_all_together_automatically">18. Testing them all together automatically</a></li>
<li><a href="#_troubleshooting_a_test_run">19. Troubleshooting a test run</a></li>
<li><a href="#_adding_configuration_and_general_api_documentation_to_product_composite_service_application">20. Adding configuration and general API documentation to Product Composite Service Application</a></li>
<li><a href="#_to_list_docker_container_by_name">21. To list docker container by name</a></li>
<li><a href="#_retrieve_mongodb_mysql">22. Retrieve MongoDB &amp; mysql</a></li>
<li><a href="#_run_persistent_test_on_product_service">23. Run persistent test on product-service</a></li>
<li><a href="#_the_docker_compose_configuration">24. The Docker Compose configuration</a></li>
<li><a href="#_database_connect_configuration">25. Database connect configuration</a></li>
<li><a href="#_the_mongodb_and_mysql_cli_tools">26. The MongoDB and MySQL CLI tools</a></li>
<li><a href="#_manual_tests_of_the_new_apis_and_the_persistence_layer">27. Manual tests of the new APIs and the persistence layer</a></li>
<li><a href="#_choosing_between_non_blocking_synchronous_apis_and_event_driven_asynchronous_services">28. Choosing between non-blocking synchronous APIs and event-driven asynchronous services</a></li>
<li><a href="#_dealing_with_blocking_code">29. Dealing with blocking code</a></li>
<li><a href="#_staring_with_reactor_and_message_broker_implememted">30. Staring with Reactor and message broker implememted</a></li>
<li><a href="#_using_rabbitmq_without_using_partitions">31. Using RabbitMQ without using partitions</a></li>
<li><a href="#_using_rabbitmq_with_two_partitions_per_topic">32. Using RabbitMQ with two partitions per topic</a></li>
<li><a href="#_using_kafka_with_two_partitions_per_topic">33. Using Kafka with two partitions per topic</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-24">
<h2 id="_what_do_we_build">1. What do we build</h2>
<div class="sectionbody">
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-26">
<h3 id="_product_service">1.1. Product service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-27">
<p>The product service manages product information and describes each product with the following attributes:</p>
</div>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-29">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-29">
<p>Product ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-30">
<p>Name</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-31">
<p>Weight</p>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-33">
<h3 id="_review_service">1.2. Review service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-34">
<p>The review service manages product reviews and stores the following information about each review:</p>
</div>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-36">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-36">
<p>Product ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-37">
<p>Review ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-38">
<p>Author</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-39">
<p>Subject</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-40">
<p>Content</p>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-42">
<h3 id="_recommendation_service">1.3. Recommendation service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-43">
<p>The recommendation service manages product recommendations and stores the following information about each recommendation:</p>
</div>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-45">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-45">
<p>Product ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-46">
<p>Recommendation ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-47">
<p>Author</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-48">
<p>Rate</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-49">
<p>Content</p>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-51">
<h3 id="_product_composite_service">1.4. Product composite service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-52">
<p>The product composite service aggregates information from the three core services and presents information about a product as follows:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-54">
<p>Product information, as described in the product service
A list of product reviews for the specified product, as described in the review service
A list of product recommendations for the specified product, as described in the recommendation service</p>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-58">
<h2 id="_start_all">2. Start ALL</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-61">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">java -jar microservices/product-composite-service/build/libs/*.jar &amp;
java -jar microservices/product-service/build/libs/*.jar &amp;
java -jar microservices/recommendation-service/build/libs/*.jar &amp;
java -jar microservices/review-service/build/libs/*.jar &amp;

To get the JSON response pretty-printed, you can use the jq tool

curl http://localhost:7000/product-composite/1 -s | jq .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-72">
<h2 id="_stop_all">3. STOP ALL</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-74">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">----ÃŸ
kill $(jobs -p)
----</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-78">
<h2 id="_find_application_used_specifing_port">4. Find application used specifing port</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-81">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">lsof -i:7002</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-85">
<h2 id="_curl_with_prety">5. Curl with prety</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-87">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">curl http://localhost:7000/product-composite/1 -s | jq .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-91">
<h2 id="_preventing_slow_lookup_of_the_localhost_hostname">6. Preventing slow lookup of the localhost hostname</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-93">
<p>With effect from macOS Sierra, looking up the hostname that&#8217;s used by the localhost in a Java program on a macOS can take a very long time, that is, 5 seconds, making tests very slow. The problem seems to be fixed when using macOS Mojave, but if you are using an older version of macOS, this can easily be fixed.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-95">
<p>First, you need to verify whether the problem affects you by downloading a small tool from GitHub and running it:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-98">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">git clone https://github.com/thoeni/inetTester.git
java -jar inetTester/bin/inetTester.jar


jonny@jonnys-MacBook-Air from-git $ java -jar inetTester/bin/inetTester.jar
Calling the hostname resolution method...
Method called, hostname jonnys-MacBook-Air.local, elapsed time: 13 (ms)

If you have a response time of 5 seconds, then you have a problem!

The solution is to edit the /etc/hosts file and add your local hostname, which is Magnuss-Mac.local in the preceding example, after localhost; for example:

127.0.0.1 localhost Magnuss-Mac.local
::1       localhost Magnuss-Mac.local</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-115">
<h2 id="_adding_semi_automated_tests_of_a_microservice_landscape">7. Adding semi-automated tests of a microservice landscape</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-117">
<p>Being able to automatically test each microservice in isolation is, of course, very useful, but insufficient!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-119">
<p>We need a way to automatically test all of our microservices to ensure that they deliver what we expect!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-121">
<p>For this reason, I have written a simple bash script that can perform calls to a RESTful API using curl and verify its return code and parts of its JSON response using jq. The script contains two helper functions, assertCurl() and assertEqual(), to make the test code compact and easier to read.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-123">
<p>For example, making a normal request and expecting 200 as the status code, as well as asserting that we get back a JSON response that returns the requested productId along with three recommendations and three reviews, looks like the following:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-126">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux"># Verify that a normal request works, expect three recommendations and three reviews
assertCurl 200 &quot;curl http://$HOST:${PORT}/product-composite/1 -s&quot;
assertEqual 1 $(echo $RESPONSE | jq .productId)
assertEqual 3 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 3 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

Verifying that we get 404 (Not Found) back as an HTTP response code (when we try to look up a product that doesn't exist) looks as follows:

# Verify that a 404 (Not Found) error is returned for a non-existing productId (13)
assertCurl 404 &quot;curl http://$HOST:${PORT}/product-composite/13 -s&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-139">
<h2 id="_semi_automatic_test_script">8. Semi Automatic Test Script</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-142">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">#!/usr/bin/env bash
#
# Sample usage:
#
#   HOST=localhost PORT=7000 ./test-em-all.bash
#
: ${HOST=localhost}
: ${PORT=7000}

function assertCurl() {

  local expectedHttpCode=$1
  local curlCmd=&quot;$2 -w \&quot;%{http_code}\&quot;&quot;
  local result=$(eval $curlCmd)
  local httpCode=&quot;${result:(-3)}&quot;
  RESPONSE='' &amp;&amp; (( ${#result} &gt; 3 )) &amp;&amp; RESPONSE=&quot;${result%???}&quot;

  if [ &quot;$httpCode&quot; = &quot;$expectedHttpCode&quot; ]
  then
    if [ &quot;$httpCode&quot; = &quot;200&quot; ]
    then
      echo &quot;Test OK (HTTP Code: $httpCode)&quot;
    else
      echo &quot;Test OK (HTTP Code: $httpCode, $RESPONSE)&quot;
    fi
  else
      echo  &quot;Test FAILED, EXPECTED HTTP Code: $expectedHttpCode, GOT: $httpCode, WILL ABORT!&quot;
      echo  &quot;- Failing command: $curlCmd&quot;
      echo  &quot;- Response Body: $RESPONSE&quot;
      exit 1
  fi
}

function assertEqual() {

  local expected=$1
  local actual=$2

  if [ &quot;$actual&quot; = &quot;$expected&quot; ]
  then
    echo &quot;Test OK (actual value: $actual)&quot;
  else
    echo &quot;Test FAILED, EXPECTED VALUE: $expected, ACTUAL VALUE: $actual, WILL ABORT&quot;
    exit 1
  fi
}
set -e

echo &quot;HOST=${HOST}&quot;
echo &quot;PORT=${PORT}&quot;


# Verify that a normal request works, expect three recommendations and three reviews
assertCurl 200 &quot;curl http://$HOST:$PORT/product-composite/1 -s&quot;
assertEqual 1 $(echo $RESPONSE | jq .productId)
assertEqual 3 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 3 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

# Verify that a 404 (Not Found) error is returned for a non existing productId (13)
assertCurl 404 &quot;curl http://$HOST:$PORT/product-composite/13 -s&quot;

# Verify that no recommendations are returned for productId 113
assertCurl 200 &quot;curl http://$HOST:$PORT/product-composite/113 -s&quot;
assertEqual 113 $(echo $RESPONSE | jq .productId)
assertEqual 0 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 3 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

# Verify that no reviews are returned for productId 213
assertCurl 200 &quot;curl http://$HOST:$PORT/product-composite/213 -s&quot;
assertEqual 213 $(echo $RESPONSE | jq .productId)
assertEqual 3 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 0 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

# Verify that a 422 (Unprocessable Entity) error is returned for a productId that is out of range (-1)
assertCurl 422 &quot;curl http://$HOST:$PORT/product-composite/-1 -s&quot;
assertEqual &quot;\&quot;Invalid productId: -1\&quot;&quot; &quot;$(echo $RESPONSE | jq .message)&quot;

# Verify that a 400 (Bad Request) error error is returned for a productId that is not a number, i.e. invalid format
assertCurl 400 &quot;curl http://$HOST:$PORT/product-composite/invalidProductId -s&quot;
assertEqual &quot;\&quot;Type mismatch.\&quot;&quot; &quot;$(echo $RESPONSE | jq .message)&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-227">
<h2 id="_knowing_how_many_core">9. Knowing how many core</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-230">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">echo 'Runtime.getRuntime().availableProcessors()' | jshell -q</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-234">
<h2 id="_knowing_how_many_heap">10. Knowing how many heap</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-235">
<p>In terms of the amount of available memory, let&#8217;s ask the JVM for the maximum size that it thinks it can allocate for the heap. We can achieve this by asking the JVM for extra runtime information using the -XX:+PrintFlagsFinal Java option and then using the grep command to filter out the MaxHeapSize parameter, like so:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-238">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

On my machine, I get the following response:



8589934592 bytes happens to be exactly 8 GB, that is, 8 * 1,024^3. Given that we don't specify any max heap size for the JVM using the -Xmx parameter, the JVM will set the max value to one quarter of the available memory. Since my laptop has 32 GB of memory and 32/4=8, this is also as expected!

Let's wrap this up by verifying that we can lower the maximum heap size with the -Xmx parameter to, for example, 200 MB:

java -Xmx200m -XX:+PrintFlagsFinal -version | grep MaxHeapSize

The JVM will respond with 209,715,200 bytes, that is, 200 * 1,024^3 bytes = 200 MB, as expected!

Now that we have seen how the Java commands work without Docker, let's try this with Docker!s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-257">
<h2 id="_cpu">11. CPU</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-258">
<p>Let&#8217;s start by applying no constraints, that is, the same test that we did without Docker:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-260">
<p>echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i openjdk:12.0.2 jshell -q
This command will send the Runtime.getRuntime().availableProcessors() string to the Docker container that will process the string using jshell.
It will respond with the same result, that is, $1 =&#8658; 12 in my case. Let&#8217;s move on and restrict the Docker container to only be allowed to use three CPU cores using the --cpus 3 Docker option and ask the JVM about how many available processors it sees:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-265">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpus 3 openjdk:12.0.2 jshell -q

The JVM now responds with $1 ==&gt; 3, that is, Java SE 12 honors the settings in the container and will, therefore, be able to configure CPU-related resources such as thread pools correctly!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-271">
<p>Let&#8217;s also try to specify a relative share of the available CPUs instead of an exact number of CPUs. 1,024 shares correspond to one core by default, so if we want to limit the container to two cores, we set the --cpu-shares Docker option to 2,048, like so:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-274">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpu-shares 2048 openjdk:12.0.2 jshell -q

The JVM will respond with $1 ==&gt; 2, that is, Java SE 12 honors the relative share option as well!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-280">
<p>While the --cpus option is a hard constraint, the --cpu-shares option only applies when the Docker host is under high load. This means that a container can consume more CPU than what the share option indicates whether CPU capacity is available.
Let&#8217;s try out limiting the amount of memory next.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-284">
<h2 id="_memory">12. Memory</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-285">
<p>With no memory constraints, Docker will allocate one-fourth of the memory to the container:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-288">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run -it --rm openjdk:12.0.2 java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

It will respond with 4,202,692,608 bytes, which equals 4 GB, that is, 8 * 1024^3. Since my Docker host has 16 GB of memory, this is correct, that is, 16/4 = 4.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-294">
<p>However, if we constrain the Docker container to only use up to 1 GB of memory using the -m=1024M Docker option, we will see a lower memory allocation:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-296">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run -it --rm -m=1024M openjdk:12.0.2 java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

The JVM will respond with 268,435,456 bytes, which equals 256 MB, that is, 2 * 1024^2 bytes. 256 MB is one-fourth of 1 GB, so again, this is as expected.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-303">
<p>We can, as usual, set the max heap size ourselves. For example, if we want to allow the heap to use 800 MB of the total 1 GB we have, we can specify that using the -Xmx800m Java option:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-305">
<p>docker run -it --rm -m=1024M openjdk:12.0.2 java -Xmx800m -XX:+PrintFlagsFinal -version | grep MaxHeapSize
The JVM will respond with 838,860,800 bytes = 800 * 1024^2 bytes = 800 MB, as expected.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-308">
<p>Let&#8217;s conclude with some out of memory tests to ensure that this really works.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-310">
<p>Let&#8217;s allocate some memory using jshell in a JVM that runs in a container that has been given 1 GB of memory; that is, it has a max heap size of 256 MB.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-312">
<p>First, try to allocate a byte array of 100 MB:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-314">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'new byte[100_000_000]' | docker run -i --rm -m=1024M openjdk:12.0.2 jshell -q

The command will respond with $1 ==&gt;, meaning that it worked fine!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-320">
<p>Normally, jshell will print out the value resulting from the command, but 100 MB of bytes all set to zero is a bit too much printout, and so we get nothing.
Now, let&#8217;s try to allocate a byte array that is larger than the max heap size, for example, 500 MB:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-324">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'new byte[500_000_000]' | docker run -i --rm -m=1024M openjdk:12.0.2 jshell -q

The JVM sees that it can't perform the action since it honors the container settings of max memory and responds immediately with Exception java.lang.OutOfMemoryError: Java heap space. Great!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-330">
<p>What would happen in this case if we use a JVM that doesn&#8217;t honor the container settings of max memory?</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-333">
<h2 id="_problems_with_docker_and_java_se_9_or_older">13. Problems with Docker and Java SE 9 (or older)</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-334">
<p>First, try out limiting a Java SE 9 JVM to three CPU cores using openjdk:9-jdk image.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-336">
<p>Java 9 fails to obey the three-CPU limit:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-339">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="teminal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpus 3 openjdk:9-jdk jshell -q

It responds with $1 ==&gt; 12 on my machine, that is, it ignores the limitation of three CPU cores.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-346">
<p>We will see the same result, that is, $1 =&#8658; 12, if we try out the --cpu-shares option:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-349">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="termninal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpu-shares 2048 openjdk:9-jdk jshell -q

Now, let's try to limit the memory to 1 GB:</code></pre>
</div>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-356">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run -it --rm -m=1024M openjdk:9-jdk java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

As expected, Java SE 9 does not honor the memory constraint that we set in Docker; that is, it reports a max heap size of 4,202,692,608 bytes = 4 GB â€“ 4 * 1024^3 bytes. Here, Java 9 calculated the available memory when given the memory in the Docker host, not in the actual container!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-362">
<p>So, what happens if we repeat the memory allocation tests that we did for Java SE 12?</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-364">
<p>Let&#8217;s try out the first test, that is, allocating a 100 MB array:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-367">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="termninal">echo 'new byte[100_000_000]' | docker run -i --rm -m=1024M openjdk:9-jdk jshell -q

The command responds with $1 ==&gt; byte[100000000] { 0, 0, 0, ..., so that worked fine!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-373">
<p>Now, let&#8217;s move on to the really interesting test: what if we allocate a byte array of 500 MB that doesn&#8217;t fit in the memory that was allocated to the container by Docker?</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-376">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'new byte[500_000_000]' | docker run -i --rm -m=1024M openjdk:9-jdk jshell -q

From a Java perspective, this should work. Since Java thinks the total memory is 16 GB, it has set the max heap size to 4 GB, so it happily starts to allocate 500 MB for the byte array. But after a while, the total size of the JVM exceeds 1 GB and Docker will kill the container with no mercy, resulting in a confusing exception such as State engine terminated. We basically have no clue what went wrong, even though we can guess that we ran out of memory.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-382">
<p>So, to summarize, if you plan to do any serious work with Docker and Java, ensure that you use Java SE 10 or later!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-384">
<p>To be fair to Java SE 9, it should be mentioned that Java SE 9 contains some initial support for cgroups. If you specify the Java options -XX:+UnlockExperimentalVMOptions and -XX:+UseCGroupMemoryLimitForHeap, it will honor parts of the cgroup constraints, but not all of them, and it should be noted that this is only experimental. Due to this, it should be avoided in production environments. Simply use Java SE 10 or later in Docker!</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-386">
<h2 id="_building_a_docker_image">14. Building a Docker image</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-388">
<p>adding spring profiles on application.yml:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-391">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span>
<span style="color:#606">spring.profiles</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">docker</span></span>

<span style="color:#606">server.port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">8080</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-398">
<p>adding Dockerfile</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-400">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#F00;background-color:#FAA">FROM openjdk:12.0.2</span>

<span style="color:#F00;background-color:#FAA">EXPOSE 8080</span>

<span style="color:#F00;background-color:#FAA">ADD ./build/libs/*.jar app.jar</span>

<span style="color:#F00;background-color:#FAA">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-410">
<p>build docker image</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-412">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./gradlew :microservices:product-service:build

Since we only want to build product-service and the projects it depends on, api and util, we don't use the normal build command, which builds all the microservices, but a variant that tells Gradle to only build product-service: :microservices:product-service:build.
We can find the fat-jar file in the Gradle build library, build/libs. For example, the ls -l microservices/product-service/build/libs command will report something like the following:

Next, we will build the Docker image and name it product-service, as follows:

cd microservices/product-service

docker build -t product-service .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-425">
<h2 id="_starting_up_docker">15. Starting up Docker</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-428">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run --rm -p8080:8080 -e &quot;SPRING_PROFILES_ACTIVE=docker&quot; product-service


1. docker run: The Docker run command will start the container and display log output in Terminal. Terminal will be locked as long as the container runs.

2. We have seen the --rm option already; it will tell Docker to clean up the container once we stop the execution from Terminal using Ctrl + C.

3.The -p8080:8080 option maps port 8080 in the container to port 8080 in the Docker host, which makes it possible to call it from the outside. In the case of Docker for macOS, which runs Docker in a local Linux virtual machine, the port will also be port-forwarded to macOS, which is made available on localhost. We can only have one container mapping to a specific port in the Docker host!

4.With the -e option, we can specify environment variables for the container, which in this case is SPRING_PROFILES_ACTIVE=docker. The SPRING_PROFILES_ACTIVE environment variable is used to tell Spring what profile to use. In our case, we want Spring to use the docker profile.

5. Finally, we have product-service, which is the name of the Docker image that Docker will use to start the container.</code></pre>
</div>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-444">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">curl localhost:8080/product/3 -s | jq

{
  &quot;productId&quot;: 3,
  &quot;name&quot;: &quot;name-3&quot;,
  &quot;weight&quot;: 123,
  &quot;serviceAddress&quot;: &quot;212e9da48c4b/172.17.0.2:8080&quot;
}

serviceAdrress = dockerId/ipAssignedByDocker:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-457">
<h2 id="_running_the_container_detached">16. Running the container detached</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-459">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="teminal">docker run -d -p8080:8080 -e &quot;SPRING_PROFILES_ACTIVE=docker&quot; --name my-prd-srv product-service

Okay, that was great, but what if we don't want to hang the Terminal windows from where we started the container?

It's time to start the container as detached, that is, running the container without locking Terminal!

We can do this by adding the -d option and at the same time giving it a name using the --name option. The --rm option is no longer required since we will stop and remove the container explicitly when we are done with it:

Check docker logs

docker logs my-prd-srv -f

The -f option tells the command to follow the log output, that is, not end the command when all the current log output has been written to Terminal, but also wait for more output. If you expect a lot of old log messages that you don't want to see, you can also add the --tail 0 option so that you only see new log messages. Alternatively, you can use the --since option and use either an absolute timestamp or a relative time, for example, --since 5m, to see log messages that are at most five minutes old.

Try this out with a new curl request. You should see that a new log message has been written to the log output in Terminal!</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-477">
<h2 id="_docker_compose">17. Docker Compose</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-479">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">version</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'2.1'</span></span>

<span style="color:#606">services</span>:
  <span style="color:#606">product</span>:
    <span style="color:#606">build</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">microservices/product-service</span></span>
    <span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
    <span style="color:#606">environment</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_PROFILES_ACTIVE=docker</span></span>

  <span style="color:#606">recommendation</span>:
    <span style="color:#606">build</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">microservices/recommendation-service</span></span>
    <span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
    <span style="color:#606">environment</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_PROFILES_ACTIVE=docker</span></span>

  <span style="color:#606">review</span>:
    <span style="color:#606">build</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">microservices/review-service</span></span>
    <span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
    <span style="color:#606">environment</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_PROFILES_ACTIVE=docker</span></span>

  <span style="color:#606">product-composite</span>:
    <span style="color:#606">build</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">microservices/product-composite-service</span></span>
    <span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
    <span style="color:#606">ports</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">8080:8080</span><span style="color:#710">&quot;</span></span>
    <span style="color:#606">environment</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_PROFILES_ACTIVE=docker</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-512">
<p>Build using docker-compose</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-515">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./gradlew build

then for creating docker images

docker-compose build


to chech all images

docker images | grep hands-on-microservice

will display :

REPOSITORY                                TAG                 IMAGE ID            CREATED             SIZE
hands-on-microservice_product-composite   latest              59d5daea1836        10 seconds ago      492MB
hands-on-microservice_review              latest              932dafb8336d        15 seconds ago      492MB
hands-on-microservice_recommendation      latest              8621920f1e36        18 seconds ago      492MB
hands-on-microservice_product             latest              63d0c369b7d9        21 seconds ago      492MB


then start docker using docker compose

docker-compose up -d

check the log

docker-compose logs -f

The Docker Compose logs command also supports restricting the log output to a group of containers. Simply add the names of the containers you want to see the log output of after the logs command. For example, to only see log output from the product and review service,

use docker-compose logs -f product review.</code></pre>
</div>
</div>
<div class="admonitionblock note has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-551">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-552">
<p>Please note that the service can be accessed from outside is only the product-compisite service
since at the docker compose file we only expose port to the out world from product-composite service</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-558">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">curl localhost:8080/product-composite/3 -s | jq
{
  &quot;productId&quot;: 3,
  &quot;name&quot;: &quot;name-3&quot;,
  &quot;weight&quot;: 123,
  &quot;recommendations&quot;: [
    {
      &quot;recommendationId&quot;: 1,
      &quot;author&quot;: &quot;Author 1&quot;,
      &quot;rate&quot;: 1
    },
    {
      &quot;recommendationId&quot;: 2,
      &quot;author&quot;: &quot;Author 2&quot;,
      &quot;rate&quot;: 2
    },
    {
      &quot;recommendationId&quot;: 3,
      &quot;author&quot;: &quot;Author 3&quot;,
      &quot;rate&quot;: 3
    }
  ],
  &quot;reviews&quot;: [
    {
      &quot;reviewId&quot;: 1,
      &quot;author&quot;: &quot;Author 1&quot;,
      &quot;subject&quot;: &quot;Subject 1&quot;
    },
    {
      &quot;reviewId&quot;: 2,
      &quot;author&quot;: &quot;Author 2&quot;,
      &quot;subject&quot;: &quot;Subject 2&quot;
    },
    {
      &quot;reviewId&quot;: 3,
      &quot;author&quot;: &quot;Author 3&quot;,
      &quot;subject&quot;: &quot;Subject 3&quot;
    }
  ],
  &quot;serviceAddresses&quot;: {
    &quot;cmpositeServiceAddress&quot;: &quot;f4840be3dc7a/172.19.0.3:8080&quot;,
    &quot;productServiceAddress&quot;: &quot;e083d1d3672a/172.19.0.2:8080&quot;,
    &quot;reviewServiceAddress&quot;: &quot;9a8791c7c8d1/172.19.0.4:8080&quot;,
    &quot;recomendationServiceAddress&quot;: &quot;d250e1b12752/172.19.0.5:8080&quot;
  }
}

if you try the product will response 404 because we did not expose port for the others except product-composite

curl localhost:8080/product/3 -s | jq
{
  &quot;timestamp&quot;: &quot;2020-03-20T09:12:10.421+0000&quot;,
  &quot;path&quot;: &quot;/product/3&quot;,
  &quot;status&quot;: 404,
  &quot;error&quot;: &quot;Not Found&quot;,
  &quot;message&quot;: null,
  &quot;requestId&quot;: &quot;4df53df5-7&quot;
}

to stop :

docker-compose down</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-623">
<h2 id="_testing_them_all_together_automatically">18. Testing them all together automatically</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-625">
<p>Docker Compose is really helpful when it comes to manually managing a group of microservices! In this section, we will take this one step further and integrate Docker Compose into our test script, test-em-all.bash. The test script will automatically start up the microservice landscape, run all the required tests to verify that the microservice landscape works as expected, and finally tear it down, leaving no traces behind.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-627">
<p>The test script can be found at $BOOK_HOME/Chapter04/test-em-all.bash.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-629">
<p>Before the test script runs the test suite, it will check for the presence of a start argument in the invocation of the test script. If found, it will restart the containers with the following code:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-632">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">if [[ $@ == *&quot;start&quot;* ]]
then
echo &quot;Restarting the test environment...&quot;
echo &quot;$ docker-compose down&quot;
docker-compose down
echo &quot;$ docker-compose up -d&quot;
docker-compose up -d
fi</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-643">
<p>After that, the test script will wait for the product-composite service to respond with OK:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-646">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">waitForService http://$HOST:${PORT}/product-composite/1</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-650">
<p>The waitForService bash function can be implemented like so:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-653">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">function testUrl() {
url=$@
if curl $url -ks -f -o /dev/null
then
echo &quot;Ok&quot;
return 0
else
echo -n &quot;not yet&quot;
return 1
fi;
}

function waitForService() {
url=$@
echo -n &quot;Wait for: $url... &quot;
n=0
until testUrl $url
do
n=$((n + 1))
if [[ $n == 100 ]]
then
echo &quot; Give up&quot;
exit 1
else
sleep 6
echo -n &quot;, retry #$n &quot;
fi
done
}</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-686">
<p>Next, all the tests are executed like they were previously. Afterward, they will tear down the landscape if it finds the stop argument in the invocation of the test scripts:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-689">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">if [[ $@ == *&quot;stop&quot;* ]]
then
echo &quot;We are done, stopping the test environment...&quot;
echo &quot;$ docker-compose down&quot;
docker-compose down
fi</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-699">
<p>Note that the test script will not tear down the landscape if some tests fail; it will simply stop, leaving the landscape up for error analysis!
The test script has also changed the default port from 7000, which we used when we ran the microservices without Docker, to 8080, which is used by our Docker containers.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-702">
<p>Let&#8217;s try it out! To start the landscape, run the tests and tear it down afterward, like so:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-705">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./test-em-all.bash start stop</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-709">
<p>The following is some sample output from a test run (with output from the specific tests that were deleted):</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-713">
<p>After testing these, we can now move on to see how to troubleshoot tests that fail.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-716">
<h2 id="_troubleshooting_a_test_run">19. Troubleshooting a test run</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-718">
<p>If the tests that were running ./test-em-all.bash start stop fail, following these steps can help you identify the problem and resume the tests once the problem has been fixed:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-720">
<p>First, check the status of the running microservices with the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-723">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose ps</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-727">
<p>If all the microservices are up and running and healthy, you will receive the following output:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-730">
<p>If any of the microservices do not have a status of Up, check its log output for any errors by using the docker-compose logs command. For example, you would use the following code if you wanted to check the log output for the product service:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-733">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose logs product</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-737">
<p>If errors in the log output indicate that Docker is running out of disk space, parts of it can be reclaimed with the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-740">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker system prune -f --volumes</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-744">
<p>If required, you can restart a failed microservice with the docker-compose up -d --scale command. For example, you would use the following code if you wanted to restart the product service:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-747">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose up -d --scale product=0
docker-compose up -d --scale product=1</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-752">
<p>If a microservice is missing, for example, due to a crash, you start it up with the docker-compose up -d --scale command. For example, you would use the following code for the product service:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-755">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose up -d --scale product=1</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-761">
<p>Once all the microservices are up and running and healthy, run the test script again, but without starting the microservices:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-764">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./test-em-all.bash</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-768">
<p>The tests should run fine!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-770">
<p>Finally, a tip about a combined command that builds runtime artifacts and Docker images from source and then runs all the tests in Docker:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-773">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./gradlew clean build &amp;&amp; docker-compose build &amp;&amp; ./test-em-all.bash start stop</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-777">
<p>This is perfect if you want to check that everything works before you push new code to your Git repository or as part of a build pipeline in your build server!</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-780">
<h2 id="_adding_configuration_and_general_api_documentation_to_product_composite_service_application">20. Adding configuration and general API documentation to Product Composite Service Application</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-783">
<p>To enable SpringFox in the product-composite-service microservice, we have to add a configuration. To keep the source code compact, we will add it directly to the ProductCompositeServiceApplication application class.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-785">
<p>If you prefer, you can place the configuration of SpringFox in a separate Spring configuration class.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-788">
<p>First, we need to add the @EnableSwagger2WebFlux annotation in order to get SpringFox to generate Swagger V2 documentation for our RESTful services, which is implemented using Spring WebFlux. Next, we need to define a Spring Bean that returns a SpringFox Docket bean, which is used to configure SpringFox.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-790">
<p>The source code that we will be adding to $BOOK_HOME/Chapter05/microservices/product-composite-service/src/main/java/se/magnus/microservices/composite/product/ProductCompositeServiceApplication.java looks as follows:</p>
</div>
<div class="listingblock java has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-793">
<div class="content">
<pre class="CodeRay highlight"><code>@EnableSwagger2WebFlux
public class ProductCompositeServiceApplication {

   @Bean
   public Docket apiDocumentation() {
      return new Docket(SWAGGER_2)
         .select()
         .apis(basePackage(&quot;se.magnus.microservices.composite.product&quot;))
         .paths(PathSelectors.any())
         .build()
            .globalResponseMessage(GET, emptyList())
            .apiInfo(new ApiInfo(
                   apiTitle,
                   apiDescription,
                   apiVersion,
                   apiTermsOfServiceUrl,
                   new Contact(apiContactName, apiContactUrl,
                    apiContactEmail),
                   apiLicense,
                   apiLicenseUrl,
                   emptyList()
                                  ));
    }</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-819">
<p>From the preceding code, we can understand the following:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-821">
<p>The @EnableSwagger2WebFlux annotation is the starting point for initiating SpringFox.
The Docket bean is initiated to create Swagger V2 documentation.
Using the apis() and paths() methods, we can specify where SpringFox shall look for API documentation.
Using the globalResponseMessage() method, we ask SpringFox not to add any default HTTP response codes to the API documentation, such as 401 and 403, which we don&#8217;t currently use.
The api* variables that are used to configure the Docket bean with general information about the API are initialized from the property file using Spring @Value annotations. These are as follows:</p>
</div>
<div class="listingblock java has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-828">
<div class="content">
<pre class="CodeRay highlight"><code>@Value(&quot;${api.common.version}&quot;)           String apiVersion;
@Value(&quot;${api.common.title}&quot;)             String apiTitle;
@Value(&quot;${api.common.description}&quot;)       String apiDescription;
@Value(&quot;${api.common.termsOfServiceUrl}&quot;) String
apiTermsOfServiceUrl;
@Value(&quot;${api.common.license}&quot;)           String apiLicense;
@Value(&quot;${api.common.licenseUrl}&quot;)        String apiLicenseUrl;
@Value(&quot;${api.common.contact.name}&quot;)      String apiContactName;
@Value(&quot;${api.common.contact.url}&quot;)       String apiContactUrl;
@Value(&quot;${api.common.contact.email}&quot;)     String apiContactEmail;</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-841">
<p>After adding a configuration and API documentation, we can now proceed to understand how to add an API specific documentation to ProductCompositeService.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-843">
<h2 id="_to_list_docker_container_by_name">21. To list docker container by name</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-845">
<p>docker ps --format {{.Names}}</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-848">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="teminal">docker ps --format {{.Names}}

hands-on-microservice_product-composite_1
hands-on-microservice_product_1
hands-on-microservice_recommendation_1
hands-on-microservice_review_1</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-857">
<h2 id="_retrieve_mongodb_mysql">22. Retrieve MongoDB &amp; mysql</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-860">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">We will be able to see data stored in MongoDB with a command like the following:

docker-compose exec mongodb mongo product-db --quiet --eval &quot;db.products.find()&quot;

docker-compose exec mysql mysql -uuser -p review-db -e &quot;select * from reviews&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-870">
<h2 id="_run_persistent_test_on_product_service">23. Run persistent test on product-service</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-872">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./gradlew microservices:product-service:test --tests PersistenceTests</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-876">
<h2 id="_the_docker_compose_configuration">24. The Docker Compose configuration</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-878">
<p>MongoDB and MySQL are declared as follows in the Docker Compose configuration file, docker-compose.yml:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-881">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">mongodb</span>:
<span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">mongo:3.6.9</span></span>
<span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
<span style="color:#606">ports</span>:
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">27017:27017</span><span style="color:#710">&quot;</span></span>
<span style="color:#606">command</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">mongod --smallfiles</span></span>

<span style="color:#606">mysql</span>:
<span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">mysql:5.7</span></span>
<span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
<span style="color:#606">ports</span>:
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">3306:3306</span><span style="color:#710">&quot;</span></span>
<span style="color:#606">environment</span>:
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">MYSQL_ROOT_PASSWORD=rootpwd</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">MYSQL_DATABASE=review-db</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">MYSQL_USER=user</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">MYSQL_PASSWORD=pwd</span></span>
<span style="color:#606">healthcheck</span>:
<span style="color:#606">test</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">[&quot;CMD&quot;, &quot;mysqladmin&quot; ,&quot;ping&quot;, &quot;-uuser&quot;, &quot;-ppwd&quot;, &quot;-h&quot;, &quot;localhost&quot;]</span></span>
<span style="color:#606">interval</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">10s</span></span>
<span style="color:#606">timeout</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">5s</span></span>
<span style="color:#606">retries</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">10</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-906">
<p>The following is observed from the preceding code:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-908">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-908">
<p>We will use the official Docker image for MongoDB V3.6.9 and MySQL 5.7 and forward their default ports 27017 and 3306 to the Docker host, also made available on localhost when using Docker for Mac.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-910">
<p>For MySQL, we also declare some environment variables, defining the following:</p>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-912">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-912">
<p>The root password</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-913">
<p>The name of the database that will be created on image startup</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-914">
<p>A username and password for a user that is set up for the database on image startup</p>
</li>
</ul>
</div>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-916">
<p>For MySQL, we also declare a health check that Docker will run to determine the status of the MySQL database.
To avoid problems with microservices that try to connect to their databases before the database is up and running,  the product and recommendation services are declared dependent on the mongodb database, as follows:</p>
</li>
</ol>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-920">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">recommendation</span>:
    <span style="color:#606">depends_on</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">mongodb</span></span>

<span style="color:#F00;background-color:#FAA">product</span>
  <span style="color:#606">depends_on</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">mongodb</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-931">
<p>This means that Docker Compose will not start up the product and recommendation containers until the mongodb container is launched.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-933">
<p>For the same reason, the review service is declared dependent on the mysql database:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-936">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">review</span>:
<span style="color:#606">depends_on</span>:
<span style="color:#606">mysql</span>:
<span style="color:#606">condition</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">service_healthy</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-943">
<p>In this case, the review service depends on the fact that the mysql container is not only launched, but also that the mysql containers health check reports are okay. The reason for this extra step is that the initialization of the mysql container includes setting up a database and creating a superuser for the database. This takes a few seconds and, to hold back the review service to startup before this is done, we direct Docker Compose to hold back the review container from being launched until the mysql container reports that it is operational through its health check.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-945">
<h2 id="_database_connect_configuration">25. Database connect configuration</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-947">
<p>With the database in place, we now need to set up the configuration for the core microservices so they know how to connect to their databases. This is set up in each core microservice&#8217;s configuration file, src/main/resources/application.yml, in the product, recommendation, and review projects.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-949">
<p>The configuration for the product and recommendation services are similar, so we will only look into the configuration of the product services. The following part of the configuration is of interest:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-952">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">server.port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">7002</span></span>

<span style="color:#606">spring.data.mongodb</span>:
  <span style="color:#606">host</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">localhost</span></span>
  <span style="color:#606">port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">27017</span></span>
  <span style="color:#606">database</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">recommendation-db</span></span>

<span style="color:#606">logging</span>:
  <span style="color:#606">level</span>:
    <span style="color:#606">root</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">INFO</span></span>
    <span style="color:#606">se.magnus</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">DEBUG</span></span>
    <span style="color:#606">org.springframework.data.mongodb.core.MongoTemplate</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">DEBUG</span></span>

<span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span>
<span style="color:#606">spring.profiles</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">docker</span></span>

<span style="color:#606">spring.data.mongodb.host</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">mongodb</span></span>

<span style="color:#606">server.port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">8080</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-975">
<p>The following is observed from the preceding code:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-977">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-977">
<p>When running without Docker using the default Spring profile, the database is expected to be reachable on localhost:27017.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-979">
<p>Setting the log level for MongoTemplate to DEBUG will allow us to see which MongoDB statements are executed in the log.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-981">
<p>When running inside Docker using the Spring profile, Docker, the database is expected to be reachable on mongodb:27017.</p>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-983">
<p>The configuration for the review service, which affects how it connects to its SQL database, looks like the following:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-986">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">server.port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">7003</span></span>

<span style="color:#777"># Strongly recommend to set this property to &quot;none&quot; in a production environment!</span>
<span style="color:#606">spring.jpa.hibernate.ddl-auto</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">update</span></span>

<span style="color:#606">spring.datasource</span>:
  <span style="color:#606">url</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">jdbc:mysql://localhost/review-db</span></span>
  <span style="color:#606">username</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">user</span></span>
  <span style="color:#606">password</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">pwd</span></span>

<span style="color:#606">spring.datasource.hikari.initializationFailTimeout</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">60000</span></span>

<span style="color:#606">logging</span>:
  <span style="color:#606">level</span>:
    <span style="color:#606">root</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">INFO</span></span>
    <span style="color:#606">se.magnus</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">DEBUG</span></span>
    <span style="color:#606">org.hibernate.SQL</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">DEBUG</span></span>
    <span style="color:#606">org.hibernate.type.descriptor.sql.BasicBinder</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">TRACE</span></span>

<span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span>
<span style="color:#606">spring.profiles</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">docker</span></span>

<span style="color:#606">spring.datasource</span>:
  <span style="color:#606">url</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">jdbc:mysql://mysql/review-db</span></span>

<span style="color:#606">server.port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">8080</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1016">
<p>The following is observed from the preceding code:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1018">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1018">
<p>By default, Hibernate will be used by Spring Data JPA as the JPA Entity Manager.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1020">
<p>The spring.jpa.hibernate.ddl-auto property is used to tell Spring Data JPA to create new or update existing SQL tables during startup.
Note: It is strongly recommended to set the spring.jpa.hibernate.ddl-auto property to none in a production environmentâ€”this prevents Spring Data JPA to manipulate the structure of the SQL tables.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1023">
<p>When running without Docker, using the default Spring profile, the database is expected to be reachable on localhost using the default port 3306.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1025">
<p>By default, HikariCP is used by Spring Data JPA as the JDBC connection pool. To minimize startup problems on computers with limited hardware resources, the initializationFailTimeout parameter is set to 60 seconds. This means that the Spring Boot application will wait for up to 60 seconds during startup to establish a database connection.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1027">
<p>The log level settings for Hibernate will cause Hibernate to print the SQL statements used and the actual values used. Please note that, when used in a production environment, writing the actual values to the log should be avoided for privacy reasons.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1029">
<p>When running inside Docker using the Spring profile, Docker, the database is expected to be reachable on the mysql hostname using the default port 3306.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1031">
<h2 id="_the_mongodb_and_mysql_cli_tools">26. The MongoDB and MySQL CLI tools</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1033">
<p>To be able to run the database CLI tools, the Docker Compose exec command can be used.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1035">
<p>The commands described in this section will be used when we get to the manual tests in the next section. Don&#8217;t try to run them now; they will fail since we have no databases up and running yet!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1037">
<p>To start the MongoDB CLI tool, mongo, inside the mongodb container, run the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1040">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose exec mongodb mongo --quiet
&gt;

Enter exit to leave the mongo CLI.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1048">
<p>Enter exit to leave the mongo CLI.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1050">
<p>To start the MySQL CLI tool, mysql, inside the mysql container and log in to review-db using the user created at startup, run the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1053">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose exec mysql mysql -uuser -p review-db
ysql&gt;</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1058">
<p>The mysql CLI tool will prompt you for a password; you can find it in the docker-compose.yml file. Look for the value of the environment variable, MYSQL_PASSWORD.
Enter exit to leave the mysql CLI.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1061">
<h2 id="_manual_tests_of_the_new_apis_and_the_persistence_layer">27. Manual tests of the new APIs and the persistence layer</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1062">
<p>Now, it is finally time to start everything up and test it manually using the Swagger UI.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1064">
<p>Build and start the system landscape with the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1067">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">at the root of hand-on-microservice

./gradlew build &amp;&amp; docker-compose build &amp;&amp; docker-compose up</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1073">
<p>Open the Swagger UI in a web browser, <a href="http://localhost:8080/swagger-ui.html" class="bare">http://localhost:8080/swagger-ui.html</a>, and perform the following steps on the web page:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1075">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1075">
<p>Click on product-composite-service-impl and the POST method to expand them.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1076">
<p>Click on the Try it out button and go down to the body field.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1077">
<p>Replace the default value, 0,  of the productId field with 123456.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1078">
<p>Scroll down to the Execute button and click on it.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1079">
<p>Verify that the returned response code is 200.</p>
</li>
</ol>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1082">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">run application in docker

./gradlew build &amp;&amp; docker-compose build &amp;&amp; docker-compose up -d

query the mongodb

docker-compose exec mongodb mongo product-db --quiet --eval &quot;db.products.find()&quot;

docker-compose exec mongodb mongo recommendation-db --quiet --eval &quot;db.recommendations.find()&quot;

query mysql

docker-compose exec mysql mysql -uuser -p review-db -e &quot;select * from reviews&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1098">
<h2 id="_choosing_between_non_blocking_synchronous_apis_and_event_driven_asynchronous_services">28. Choosing between non-blocking synchronous APIs and event-driven asynchronous services</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1099">
<p>When developing reactive microservices, it is not always obvious when to use non-blocking synchronous APIs and when to use event-driven asynchronous services. In general, to make a microservice robust and scalable, it is important to make it as autonomous as possible, for example, minimizing its runtime dependencies. This is also known as loose coupling. Therefore, asynchronous message passing of events, is preferable over synchronous APIs. This is because the microservice will only depend on access to the messaging system at runtime instead of being dependent on synchronous access to a number of other microservices.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1101">
<p>There are, however, a number of cases where non-blocking synchronous APIs could be favorable to use, for example:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1103">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1103">
<p>For read operations where an end user is waiting for a response</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1105">
<p>Where the client platforms are more suitable for consuming synchronous APIs, for example, mobile apps or SPA web applications</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1107">
<p>Where the clients will connect to the service from other organizationsâ€”where it might be hard to agree over a common messaging system to use across organizations</p>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1109">
<p>For the system landscape used in this book, we will use the following:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1111">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1111">
<p>The create, read, and delete services exposed by the product composite microservice will be based on synchronous APIs. The composite microservice is assumed to have clients on both web and mobile platforms, as well as clients coming from other organizations rather than the ones that operate the system landscape. Therefore, synchronous APIs seem like a natural match.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1112">
<p>The read services provided by the core microservices will also be developed as non-blocking synchronous APIs since there is an end user waiting for their responses.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1113">
<p>The create and delete services provided by the core microservices will be developed as event-driven asynchronous services. The synchronous APIs provided by the composite microservices to create and delete aggregated product information will simply publish, create, and delete events on the topics that the core services listen on and then return with a 200 (OK) response.</p>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1116">
<p>This is illustrated by the following diagram:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1120">
<p>First, let&#8217;s learn how we can develop non-blocking synchronous REST APIs, and thereafter, we will look at how to develop event-driven asynchronous services.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1122">
<p><span class="image"><img src="images/1.png" alt="1"></span></p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1124">
<h2 id="_dealing_with_blocking_code">29. Dealing with blocking code</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1126">
<p>In the case of the review service, which uses JPA to access its data in a relational database, we don&#8217;t have support for a non-blocking programming model. Instead, we can run the blocking code using Scheduler, which is capable of running the blocking code on a thread from a dedicated thread pool with a limited number of threads. Using a thread pool for the blocking code avoids draining the available threads in the microservice (avoids affecting the non-blocking processing in the microservice).</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1128">
<p>Let&#8217;s see how this process works, as laid out in the following steps:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1130">
<p>see the Review microservices</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1132">
<h2 id="_staring_with_reactor_and_message_broker_implememted">30. Staring with Reactor and message broker implememted</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1135">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">./gradlew build &amp;&amp; docker-compose build &amp;&amp; docker-compose up -d


body='{&quot;productId&quot;:1,&quot;name&quot;:&quot;product name C&quot;,&quot;weight&quot;:300, &quot;recommendations&quot;:[
 {&quot;recommendationId&quot;:1,&quot;author&quot;:&quot;author 1&quot;,&quot;rate&quot;:1,&quot;content&quot;:&quot;content 1&quot;},
 {&quot;recommendationId&quot;:2,&quot;author&quot;:&quot;author 2&quot;,&quot;rate&quot;:2,&quot;content&quot;:&quot;content 2&quot;},
 {&quot;recommendationId&quot;:3,&quot;author&quot;:&quot;author 3&quot;,&quot;rate&quot;:3,&quot;content&quot;:&quot;content 3&quot;}
], &quot;reviews&quot;:[
 {&quot;reviewId&quot;:1,&quot;author&quot;:&quot;author 1&quot;,&quot;subject&quot;:&quot;subject 1&quot;,&quot;content&quot;:&quot;content 1&quot;},
 {&quot;reviewId&quot;:2,&quot;author&quot;:&quot;author 2&quot;,&quot;subject&quot;:&quot;subject 2&quot;,&quot;content&quot;:&quot;content 2&quot;},
 {&quot;reviewId&quot;:3,&quot;author&quot;:&quot;author 3&quot;,&quot;subject&quot;:&quot;subject 3&quot;,&quot;content&quot;:&quot;content 3&quot;}
]}'

curl -X POST localhost:8080/product-composite -H &quot;Content-Type: application/json&quot; --data &quot;$body&quot;

open rabbit mq

http://localhost:15672/#/queues</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1158">
<h2 id="_using_rabbitmq_without_using_partitions">31. Using RabbitMQ without using partitions</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1159">
<p>In this section, we will test the reactive microservices together with RabbitMQ but without using partitions.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1161">
<p>The default docker-compose.yml Docker Compose file is used in this configuration. The following changes have been applied to the file:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1163">
<p>RabbitMQ has been added, as shown here:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1166">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">rabbitmq</span>:
<span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">rabbitmq:3.7.8-management</span></span>
<span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
<span style="color:#606">ports</span>:
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">5672:5672</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">15672:15672</span></span>
<span style="color:#606">healthcheck</span>:
<span style="color:#606">test</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">[&quot;CMD&quot;, &quot;rabbitmqctl&quot;, &quot;status&quot;]</span></span>
<span style="color:#606">interval</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">10s</span></span>
<span style="color:#606">timeout</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">5s</span></span>
<span style="color:#606">retries</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">10</span></span>
<span style="color:#606">The microservices now have a dependency declared to the RabbitMQ service. This means that Docker will not start the microservice containers until the RabbitMQ service is reported to be healthy</span>:
<span style="color:#606">depends_on</span>:
<span style="color:#606">rabbitmq</span>:
<span style="color:#606">condition</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">service_healthy</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1184">
<p>To run our tests, perform the following steps:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1186">
<p>Build and start the system landscape with the following commands:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1189">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./gradlew build &amp;&amp; docker-compose build &amp;&amp; docker-compose up -d</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1193">
<p>Now, we have to wait for the microservice landscape to be up and running.
Try running the following command a few times:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1197">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">curl -s localhost:8080/actuator/health | jq -r .status</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1201">
<p>When it returns UP, we are ready to run our tests!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1203">
<p>First, create a composite product with the following commands:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1206">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">body='{&quot;productId&quot;:1,&quot;name&quot;:&quot;product name C&quot;,&quot;weight&quot;:300, &quot;recommendations&quot;:[
{&quot;recommendationId&quot;:1,&quot;author&quot;:&quot;author 1&quot;,&quot;rate&quot;:1,&quot;content&quot;:&quot;content 1&quot;},
{&quot;recommendationId&quot;:2,&quot;author&quot;:&quot;author 2&quot;,&quot;rate&quot;:2,&quot;content&quot;:&quot;content 2&quot;},
{&quot;recommendationId&quot;:3,&quot;author&quot;:&quot;author 3&quot;,&quot;rate&quot;:3,&quot;content&quot;:&quot;content 3&quot;}
], &quot;reviews&quot;:[
{&quot;reviewId&quot;:1,&quot;author&quot;:&quot;author 1&quot;,&quot;subject&quot;:&quot;subject 1&quot;,&quot;content&quot;:&quot;content 1&quot;},
{&quot;reviewId&quot;:2,&quot;author&quot;:&quot;author 2&quot;,&quot;subject&quot;:&quot;subject 2&quot;,&quot;content&quot;:&quot;content 2&quot;},
{&quot;reviewId&quot;:3,&quot;author&quot;:&quot;author 3&quot;,&quot;subject&quot;:&quot;subject 3&quot;,&quot;content&quot;:&quot;content 3&quot;}
]}'

curl -X POST localhost:8080/product-composite -H &quot;Content-Type: application/json&quot; --data &quot;$body&quot;</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1221">
<p>When using Spring Cloud Stream together with RabbitMQ, it will create one RabbitMQ exchange per topic and a set of queues, depending on our configuration.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1223">
<p>Let&#8217;s see what queues that Spring Cloud Stream has created for us!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1225">
<p>Open the following URL in a web browser: <a href="http://localhost:15672/#/queues" class="bare">http://localhost:15672/#/queues</a>. You should see the following queues:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1228">
<p>For each topic, we can see one queue for auditGroup, one for the consumer group that&#8217;s used by the corresponding core microservice, and one dead-letter queue. We can also see that the auditGroup queues contain messages, as expected!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1230">
<p>Click on the products.auditGroup queue and scroll down to Get Message(s), expand it, and click on the button named Get Message(s) to see the message in the queue:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1233">
<p>Next, try to get the product composite using the following code:
curl localhost:8080/product-composite/1 | jq
Finally, delete it, like so:
curl -X DELETE localhost:8080/product-composite/1
Trying to get the deleted product again should result in a 404 - "NotFound" response!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1239">
<p>If you look in the RabbitMQ audit queues again, you should be able to find new messages containing delete events.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1241">
<p>Wrap up the test by bringing down the microservice landscape with the following command:
docker-compose down
This completes the tests where we use RabbitMQ without partitions. Now, let&#8217;s move on and test RabbitMQ with partitions.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1245">
<h2 id="_using_rabbitmq_with_two_partitions_per_topic">32. Using RabbitMQ with two partitions per topic</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1246">
<p>Now, let&#8217;s try out the partitioning support in Spring Cloud Stream!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1248">
<p>We have a separate Docker Compose file prepared for using RabbitMQ with two partitions per topic: docker-compose-partitions.yml. It will also start two instances per core microservice, one for each partition. For example, a second product instance is configured as follows:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1251">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">product-p1</span>:
<span style="color:#606">build</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">microservices/product-service</span></span>
<span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
<span style="color:#606">environment</span>:
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_PROFILES_ACTIVE=docker</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_CLOUD_STREAM_BINDINGS_INPUT_CONSUMER_PARTITIONED=true</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_CLOUD_STREAM_BINDINGS_INPUT_CONSUMER_INSTANCECOUNT=2</span></span>
- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">SPRING_CLOUD_STREAM_BINDINGS_INPUT_CONSUMER_INSTANCEINDEX=1</span></span>
<span style="color:#606">depends_on</span>:
<span style="color:#606">mongodb</span>:
<span style="color:#606">condition</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">service_healthy</span></span>
<span style="color:#606">rabbitmq</span>:
<span style="color:#606">condition</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">service_healthy</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1267">
<p>Here is an explanation of the preceding source code:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1269">
<p>We use the same source code and Dockerfile that we did for the first product instance but configure them differently.
Specifically, we assign the two product instances to different partitions using the instance-index property we described earlier in this chapter.
When using system environment variables to specify Spring properties, we must use an uppercase format where dots are replaced with underscores.
This product instance will only process asynchronous events; it will not respond to API calls. Since it has a different name, product-p1 (also used as its DNS name), it will not respond to calls to a URL starting with <a href="http://product:8080" class="bare">http://product:8080</a>.
Start up the microservice landscape with the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1276">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">export COMPOSE_FILE=docker-compose-partitions.yml
docker-compose build &amp;&amp; docker-compose up -d</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1281">
<p>Repeat the tests from the previous section but also create a product with the product ID set to 2. If you take a look into the queues set up by Spring Cloud Stream, you will see one queue per partition and that the product audit queues now contain one message each, that is, the event for product ID 1 was placed in one partition and the event for product ID 2 was placed in the other partition. If you go back to <a href="http://localhost:15672/#/queues" class="bare">http://localhost:15672/#/queues</a> in your web browser, you should see something like the following:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1284">
<p>To end the test with RabbitMQ using partitions, bring down the microservice landscape with the following command:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1286">
<p>docker-compose down
unset COMPOSE_FILE
We are now done with tests using RabbitMQ, both with and without partitions. The final test configuration we shall try out is testing the microservices together with Kafka.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1290">
<h2 id="_using_kafka_with_two_partitions_per_topic">33. Using Kafka with two partitions per topic</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1292">
<p>Now, we shall try out a very cool feature of Spring Cloud Stream: changing the messaging system from RabbitMQ to Apache Kafka!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1294">
<p>This can be done simply by changing the value of the spring.cloud.stream.defaultBinder property from rabbit to kafka. This is handled by the docker-compose-kafka.yml Docker Compose file that has also replaced RabbitMQ with Kafka and Zookeeper. The configuration of Kafka and Zookeeper looks as follows:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1297">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#606">kafka</span>:
  <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">wurstmeister/kafka:2.12-2.1.0</span></span>
  <span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
  <span style="color:#606">ports</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">9092:9092</span><span style="color:#710">&quot;</span></span>
  <span style="color:#606">environment</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">KAFKA_ADVERTISED_HOST_NAME=kafka</span></span>
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">KAFKA_ADVERTISED_PORT=9092</span></span>
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181</span></span>
  <span style="color:#606">depends_on</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">zookeeper</span></span>

<span style="color:#606">zookeeper</span>:
  <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">wurstmeister/zookeeper:3.4.6</span></span>
  <span style="color:#606">mem_limit</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">350m</span></span>
  <span style="color:#606">ports</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">2181:2181</span><span style="color:#710">&quot;</span></span>
  <span style="color:#606">environment</span>:
    - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">KAFKA_ADVERTISED_HOST_NAME=zookeeper</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1319">
<p>Kafka is also configured to use two partitions per topic, and like before, we start up two instances per core microservice, one for each partition. See the Docker Compose file, docker-compose-kafka.yml, for details!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1321">
<p>Start up the microservice landscape with the following command:</p>
</div>
<div class="listingblock terminal has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1324">
<div class="content">
<pre class="CodeRay highlight"><code>export COMPOSE_FILE=docker-compose-kafka.yml
docker-compose build &amp;&amp; docker-compose up -d</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1329">
<p>Repeat the tests from the previous section, for example, create two products, one with the product ID set to 1, and one with the product ID set to 2.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1331">
<p>Unfortunately, Kafka doesn&#8217;t come with any graphical tools that can be used to inspect topics, partitions, and the messages that are placed within them. Instead, we can run CLI commands in the Kafka Docker container.
To see a list of topics, run the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1335">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">ocker-compose exec kafka /opt/kafka/bin/kafka-topics.sh --zookeeper zookeeper --list</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1339">
<p>Here is an explanation of the preceding source code:</p>
</div>
<div class="olist arabic has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1341">
<ol class="arabic">
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1341">
<p>The topics prefixed with error are the topics corresponding to dead-letter queues.</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1342">
<p>You will not find any auditGroup in the case of RabbitMQ; instead, all messages the are available in the topics for any consumer to process.</p>
</li>
</ol>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1344">
<p>To see the partitions in a specific topic, for example, the products topic, run the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1347">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose exec kafka /opt/kafka/bin/kafka-topics.sh --describe --zookeeper zookeeper --topic products</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1353">
<p>To see all the messages in a specific topic, for example, the products topic, run the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1358">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose exec kafka /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic products --from-beginning --timeout-ms 1000</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1362">
<p>To see all the messages in a specific partition, for example, partition 1 in the products topic, run the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1365">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose exec kafka /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic products --from-beginning --timeout-ms 1000 --partition 1</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1369">
<p>The output will end with a timeout exception since we stop the command by specifying a timeout for the command of 1000 ms.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1371">
<p>Bring down the microservice landscape with the following command:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1374">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker-compose down
unset COMPOSE_FILE</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-1379">
<p>Now, we have learned how Spring Cloud Stream can be used to switch a message broker from RabbitMQ to Kafka without requiring any changes in the source code. It just requires a few changes in the Docker Compose file.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
 2020-03-22 21:43:37 +0700
</div>
</div>
</body>
</html>