<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="author" content="Jonny">
<title>Micro Service</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Micro Service</h1>
<div class="details">
<span id="author" class="author">Jonny</span><br>
<span id="revdate">Tuesday, 11 February, 2020</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Content</div>
<ul class="sectlevel1">
<li><a href="#_what_do_we_build">1. What do we build</a>
<ul class="sectlevel2">
<li><a href="#_product_service">1.1. Product service</a></li>
<li><a href="#_review_service">1.2. Review service</a></li>
<li><a href="#_recommendation_service">1.3. Recommendation service</a></li>
<li><a href="#_product_composite_service">1.4. Product composite service</a></li>
</ul>
</li>
<li><a href="#_start_all">2. Start ALL</a></li>
<li><a href="#_stop_all">3. STOP ALL</a></li>
<li><a href="#_find_application_used_specifing_port">4. Find application used specifing port</a></li>
<li><a href="#_curl_with_prety">5. Curl with prety</a></li>
<li><a href="#_preventing_slow_lookup_of_the_localhost_hostname">6. Preventing slow lookup of the localhost hostname</a></li>
<li><a href="#_adding_semi_automated_tests_of_a_microservice_landscape">7. Adding semi-automated tests of a microservice landscape</a></li>
<li><a href="#_semi_automatic_test_script">8. Semi Automatic Test Script</a></li>
<li><a href="#_knowing_how_many_core">9. Knowing how many core</a></li>
<li><a href="#_knowing_how_many_heap">10. Knowing how many heap</a></li>
<li><a href="#_cpu">11. CPU</a></li>
<li><a href="#_memory">12. Memory</a></li>
<li><a href="#_problems_with_docker_and_java_se_9_or_older">13. Problems with Docker and Java SE 9 (or older)</a></li>
<li><a href="#_building_a_docker_image">14. Building a Docker image</a></li>
<li><a href="#_starting_up_docker">15. Starting up Docker</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-24">
<h2 id="_what_do_we_build">1. What do we build</h2>
<div class="sectionbody">
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-26">
<h3 id="_product_service">1.1. Product service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-27">
<p>The product service manages product information and describes each product with the following attributes:</p>
</div>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-29">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-29">
<p>Product ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-30">
<p>Name</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-31">
<p>Weight</p>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-33">
<h3 id="_review_service">1.2. Review service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-34">
<p>The review service manages product reviews and stores the following information about each review:</p>
</div>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-36">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-36">
<p>Product ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-37">
<p>Review ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-38">
<p>Author</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-39">
<p>Subject</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-40">
<p>Content</p>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-42">
<h3 id="_recommendation_service">1.3. Recommendation service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-43">
<p>The recommendation service manages product recommendations and stores the following information about each recommendation:</p>
</div>
<div class="ulist has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-45">
<ul>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-45">
<p>Product ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-46">
<p>Recommendation ID</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-47">
<p>Author</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-48">
<p>Rate</p>
</li>
<li class="has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-49">
<p>Content</p>
</li>
</ul>
</div>
</div>
<div class="sect2 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-51">
<h3 id="_product_composite_service">1.4. Product composite service</h3>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-52">
<p>The product composite service aggregates information from the three core services and presents information about a product as follows:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-54">
<p>Product information, as described in the product service
A list of product reviews for the specified product, as described in the review service
A list of product recommendations for the specified product, as described in the recommendation service</p>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-58">
<h2 id="_start_all">2. Start ALL</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-61">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">java -jar microservices/product-composite-service/build/libs/*.jar &amp;
java -jar microservices/product-service/build/libs/*.jar &amp;
java -jar microservices/recommendation-service/build/libs/*.jar &amp;
java -jar microservices/review-service/build/libs/*.jar &amp;

To get the JSON response pretty-printed, you can use the jq tool

curl http://localhost:7000/product-composite/1 -s | jq .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-72">
<h2 id="_stop_all">3. STOP ALL</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-74">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">----ß
kill $(jobs -p)
----</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-78">
<h2 id="_find_application_used_specifing_port">4. Find application used specifing port</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-81">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">lsof -i:7002</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-85">
<h2 id="_curl_with_prety">5. Curl with prety</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-87">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">curl http://localhost:7000/product-composite/1 -s | jq .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-91">
<h2 id="_preventing_slow_lookup_of_the_localhost_hostname">6. Preventing slow lookup of the localhost hostname</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-93">
<p>With effect from macOS Sierra, looking up the hostname that&#8217;s used by the localhost in a Java program on a macOS can take a very long time, that is, 5 seconds, making tests very slow. The problem seems to be fixed when using macOS Mojave, but if you are using an older version of macOS, this can easily be fixed.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-95">
<p>First, you need to verify whether the problem affects you by downloading a small tool from GitHub and running it:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-98">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">git clone https://github.com/thoeni/inetTester.git
java -jar inetTester/bin/inetTester.jar


jonny@jonnys-MacBook-Air from-git $ java -jar inetTester/bin/inetTester.jar
Calling the hostname resolution method...
Method called, hostname jonnys-MacBook-Air.local, elapsed time: 13 (ms)

If you have a response time of 5 seconds, then you have a problem!

The solution is to edit the /etc/hosts file and add your local hostname, which is Magnuss-Mac.local in the preceding example, after localhost; for example:

127.0.0.1 localhost Magnuss-Mac.local
::1       localhost Magnuss-Mac.local</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-115">
<h2 id="_adding_semi_automated_tests_of_a_microservice_landscape">7. Adding semi-automated tests of a microservice landscape</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-117">
<p>Being able to automatically test each microservice in isolation is, of course, very useful, but insufficient!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-119">
<p>We need a way to automatically test all of our microservices to ensure that they deliver what we expect!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-121">
<p>For this reason, I have written a simple bash script that can perform calls to a RESTful API using curl and verify its return code and parts of its JSON response using jq. The script contains two helper functions, assertCurl() and assertEqual(), to make the test code compact and easier to read.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-123">
<p>For example, making a normal request and expecting 200 as the status code, as well as asserting that we get back a JSON response that returns the requested productId along with three recommendations and three reviews, looks like the following:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-126">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux"># Verify that a normal request works, expect three recommendations and three reviews
assertCurl 200 &quot;curl http://$HOST:${PORT}/product-composite/1 -s&quot;
assertEqual 1 $(echo $RESPONSE | jq .productId)
assertEqual 3 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 3 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

Verifying that we get 404 (Not Found) back as an HTTP response code (when we try to look up a product that doesn't exist) looks as follows:

# Verify that a 404 (Not Found) error is returned for a non-existing productId (13)
assertCurl 404 &quot;curl http://$HOST:${PORT}/product-composite/13 -s&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-139">
<h2 id="_semi_automatic_test_script">8. Semi Automatic Test Script</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-142">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">#!/usr/bin/env bash
#
# Sample usage:
#
#   HOST=localhost PORT=7000 ./test-em-all.bash
#
: ${HOST=localhost}
: ${PORT=7000}

function assertCurl() {

  local expectedHttpCode=$1
  local curlCmd=&quot;$2 -w \&quot;%{http_code}\&quot;&quot;
  local result=$(eval $curlCmd)
  local httpCode=&quot;${result:(-3)}&quot;
  RESPONSE='' &amp;&amp; (( ${#result} &gt; 3 )) &amp;&amp; RESPONSE=&quot;${result%???}&quot;

  if [ &quot;$httpCode&quot; = &quot;$expectedHttpCode&quot; ]
  then
    if [ &quot;$httpCode&quot; = &quot;200&quot; ]
    then
      echo &quot;Test OK (HTTP Code: $httpCode)&quot;
    else
      echo &quot;Test OK (HTTP Code: $httpCode, $RESPONSE)&quot;
    fi
  else
      echo  &quot;Test FAILED, EXPECTED HTTP Code: $expectedHttpCode, GOT: $httpCode, WILL ABORT!&quot;
      echo  &quot;- Failing command: $curlCmd&quot;
      echo  &quot;- Response Body: $RESPONSE&quot;
      exit 1
  fi
}

function assertEqual() {

  local expected=$1
  local actual=$2

  if [ &quot;$actual&quot; = &quot;$expected&quot; ]
  then
    echo &quot;Test OK (actual value: $actual)&quot;
  else
    echo &quot;Test FAILED, EXPECTED VALUE: $expected, ACTUAL VALUE: $actual, WILL ABORT&quot;
    exit 1
  fi
}
set -e

echo &quot;HOST=${HOST}&quot;
echo &quot;PORT=${PORT}&quot;


# Verify that a normal request works, expect three recommendations and three reviews
assertCurl 200 &quot;curl http://$HOST:$PORT/product-composite/1 -s&quot;
assertEqual 1 $(echo $RESPONSE | jq .productId)
assertEqual 3 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 3 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

# Verify that a 404 (Not Found) error is returned for a non existing productId (13)
assertCurl 404 &quot;curl http://$HOST:$PORT/product-composite/13 -s&quot;

# Verify that no recommendations are returned for productId 113
assertCurl 200 &quot;curl http://$HOST:$PORT/product-composite/113 -s&quot;
assertEqual 113 $(echo $RESPONSE | jq .productId)
assertEqual 0 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 3 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

# Verify that no reviews are returned for productId 213
assertCurl 200 &quot;curl http://$HOST:$PORT/product-composite/213 -s&quot;
assertEqual 213 $(echo $RESPONSE | jq .productId)
assertEqual 3 $(echo $RESPONSE | jq &quot;.recommendations | length&quot;)
assertEqual 0 $(echo $RESPONSE | jq &quot;.reviews | length&quot;)

# Verify that a 422 (Unprocessable Entity) error is returned for a productId that is out of range (-1)
assertCurl 422 &quot;curl http://$HOST:$PORT/product-composite/-1 -s&quot;
assertEqual &quot;\&quot;Invalid productId: -1\&quot;&quot; &quot;$(echo $RESPONSE | jq .message)&quot;

# Verify that a 400 (Bad Request) error error is returned for a productId that is not a number, i.e. invalid format
assertCurl 400 &quot;curl http://$HOST:$PORT/product-composite/invalidProductId -s&quot;
assertEqual &quot;\&quot;Type mismatch.\&quot;&quot; &quot;$(echo $RESPONSE | jq .message)&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-227">
<h2 id="_knowing_how_many_core">9. Knowing how many core</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-230">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linux">echo 'Runtime.getRuntime().availableProcessors()' | jshell -q</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-234">
<h2 id="_knowing_how_many_heap">10. Knowing how many heap</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-235">
<p>In terms of the amount of available memory, let&#8217;s ask the JVM for the maximum size that it thinks it can allocate for the heap. We can achieve this by asking the JVM for extra runtime information using the -XX:+PrintFlagsFinal Java option and then using the grep command to filter out the MaxHeapSize parameter, like so:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-238">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

On my machine, I get the following response:



8589934592 bytes happens to be exactly 8 GB, that is, 8 * 1,024^3. Given that we don't specify any max heap size for the JVM using the -Xmx parameter, the JVM will set the max value to one quarter of the available memory. Since my laptop has 32 GB of memory and 32/4=8, this is also as expected!

Let's wrap this up by verifying that we can lower the maximum heap size with the -Xmx parameter to, for example, 200 MB:

java -Xmx200m -XX:+PrintFlagsFinal -version | grep MaxHeapSize

The JVM will respond with 209,715,200 bytes, that is, 200 * 1,024^3 bytes = 200 MB, as expected!

Now that we have seen how the Java commands work without Docker, let's try this with Docker!s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-257">
<h2 id="_cpu">11. CPU</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-258">
<p>Let&#8217;s start by applying no constraints, that is, the same test that we did without Docker:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-260">
<p>echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i openjdk:12.0.2 jshell -q
This command will send the Runtime.getRuntime().availableProcessors() string to the Docker container that will process the string using jshell.
It will respond with the same result, that is, $1 =&#8658; 12 in my case. Let&#8217;s move on and restrict the Docker container to only be allowed to use three CPU cores using the --cpus 3 Docker option and ask the JVM about how many available processors it sees:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-265">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpus 3 openjdk:12.0.2 jshell -q

The JVM now responds with $1 ==&gt; 3, that is, Java SE 12 honors the settings in the container and will, therefore, be able to configure CPU-related resources such as thread pools correctly!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-271">
<p>Let&#8217;s also try to specify a relative share of the available CPUs instead of an exact number of CPUs. 1,024 shares correspond to one core by default, so if we want to limit the container to two cores, we set the --cpu-shares Docker option to 2,048, like so:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-274">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpu-shares 2048 openjdk:12.0.2 jshell -q

The JVM will respond with $1 ==&gt; 2, that is, Java SE 12 honors the relative share option as well!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-280">
<p>While the --cpus option is a hard constraint, the --cpu-shares option only applies when the Docker host is under high load. This means that a container can consume more CPU than what the share option indicates whether CPU capacity is available.
Let&#8217;s try out limiting the amount of memory next.</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-284">
<h2 id="_memory">12. Memory</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-285">
<p>With no memory constraints, Docker will allocate one-fourth of the memory to the container:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-288">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run -it --rm openjdk:12.0.2 java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

It will respond with 4,202,692,608 bytes, which equals 4 GB, that is, 8 * 1024^3. Since my Docker host has 16 GB of memory, this is correct, that is, 16/4 = 4.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-294">
<p>However, if we constrain the Docker container to only use up to 1 GB of memory using the -m=1024M Docker option, we will see a lower memory allocation:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-296">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run -it --rm -m=1024M openjdk:12.0.2 java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

The JVM will respond with 268,435,456 bytes, which equals 256 MB, that is, 2 * 1024^2 bytes. 256 MB is one-fourth of 1 GB, so again, this is as expected.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-303">
<p>We can, as usual, set the max heap size ourselves. For example, if we want to allow the heap to use 800 MB of the total 1 GB we have, we can specify that using the -Xmx800m Java option:</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-305">
<p>docker run -it --rm -m=1024M openjdk:12.0.2 java -Xmx800m -XX:+PrintFlagsFinal -version | grep MaxHeapSize
The JVM will respond with 838,860,800 bytes = 800 * 1024^2 bytes = 800 MB, as expected.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-308">
<p>Let&#8217;s conclude with some out of memory tests to ensure that this really works.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-310">
<p>Let&#8217;s allocate some memory using jshell in a JVM that runs in a container that has been given 1 GB of memory; that is, it has a max heap size of 256 MB.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-312">
<p>First, try to allocate a byte array of 100 MB:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-314">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'new byte[100_000_000]' | docker run -i --rm -m=1024M openjdk:12.0.2 jshell -q

The command will respond with $1 ==&gt;, meaning that it worked fine!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-320">
<p>Normally, jshell will print out the value resulting from the command, but 100 MB of bytes all set to zero is a bit too much printout, and so we get nothing.
Now, let&#8217;s try to allocate a byte array that is larger than the max heap size, for example, 500 MB:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-324">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'new byte[500_000_000]' | docker run -i --rm -m=1024M openjdk:12.0.2 jshell -q

The JVM sees that it can't perform the action since it honors the container settings of max memory and responds immediately with Exception java.lang.OutOfMemoryError: Java heap space. Great!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-330">
<p>What would happen in this case if we use a JVM that doesn&#8217;t honor the container settings of max memory?</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-333">
<h2 id="_problems_with_docker_and_java_se_9_or_older">13. Problems with Docker and Java SE 9 (or older)</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-334">
<p>First, try out limiting a Java SE 9 JVM to three CPU cores using openjdk:9-jdk image.</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-336">
<p>Java 9 fails to obey the three-CPU limit:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-339">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="teminal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpus 3 openjdk:9-jdk jshell -q

It responds with $1 ==&gt; 12 on my machine, that is, it ignores the limitation of three CPU cores.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-346">
<p>We will see the same result, that is, $1 =&#8658; 12, if we try out the --cpu-shares option:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-349">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="termninal">echo 'Runtime.getRuntime().availableProcessors()' | docker run --rm -i --cpu-shares 2048 openjdk:9-jdk jshell -q

Now, let's try to limit the memory to 1 GB:</code></pre>
</div>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-356">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run -it --rm -m=1024M openjdk:9-jdk java -XX:+PrintFlagsFinal -version | grep MaxHeapSize

As expected, Java SE 9 does not honor the memory constraint that we set in Docker; that is, it reports a max heap size of 4,202,692,608 bytes = 4 GB – 4 * 1024^3 bytes. Here, Java 9 calculated the available memory when given the memory in the Docker host, not in the actual container!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-362">
<p>So, what happens if we repeat the memory allocation tests that we did for Java SE 12?</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-364">
<p>Let&#8217;s try out the first test, that is, allocating a 100 MB array:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-367">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="termninal">echo 'new byte[100_000_000]' | docker run -i --rm -m=1024M openjdk:9-jdk jshell -q

The command responds with $1 ==&gt; byte[100000000] { 0, 0, 0, ..., so that worked fine!</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-373">
<p>Now, let&#8217;s move on to the really interesting test: what if we allocate a byte array of 500 MB that doesn&#8217;t fit in the memory that was allocated to the container by Docker?</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-376">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">echo 'new byte[500_000_000]' | docker run -i --rm -m=1024M openjdk:9-jdk jshell -q

From a Java perspective, this should work. Since Java thinks the total memory is 16 GB, it has set the max heap size to 4 GB, so it happily starts to allocate 500 MB for the byte array. But after a while, the total size of the JVM exceeds 1 GB and Docker will kill the container with no mercy, resulting in a confusing exception such as State engine terminated. We basically have no clue what went wrong, even though we can guess that we ran out of memory.</code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-382">
<p>So, to summarize, if you plan to do any serious work with Docker and Java, ensure that you use Java SE 10 or later!</p>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-384">
<p>To be fair to Java SE 9, it should be mentioned that Java SE 9 contains some initial support for cgroups. If you specify the Java options -XX:+UnlockExperimentalVMOptions and -XX:+UseCGroupMemoryLimitForHeap, it will honor parts of the cgroup constraints, but not all of them, and it should be noted that this is only experimental. Due to this, it should be avoided in production environments. Simply use Java SE 10 or later in Docker!</p>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-386">
<h2 id="_building_a_docker_image">14. Building a Docker image</h2>
<div class="sectionbody">
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-388">
<p>adding spring profiles on application.yml:</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-391">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span>
<span style="color:#606">spring.profiles</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">docker</span></span>

<span style="color:#606">server.port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">8080</span></span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-398">
<p>adding Dockerfile</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-400">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml"><span style="color:#F00;background-color:#FAA">FROM openjdk:12.0.2</span>

<span style="color:#F00;background-color:#FAA">EXPOSE 8080</span>

<span style="color:#F00;background-color:#FAA">ADD ./build/libs/*.jar app.jar</span>

<span style="color:#F00;background-color:#FAA">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span></code></pre>
</div>
</div>
<div class="paragraph has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-410">
<p>build docker image</p>
</div>
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-412">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">./gradlew :microservices:product-service:build

Since we only want to build product-service and the projects it depends on, api and util, we don't use the normal build command, which builds all the microservices, but a variant that tells Gradle to only build product-service: :microservices:product-service:build.
We can find the fat-jar file in the Gradle build library, build/libs. For example, the ls -l microservices/product-service/build/libs command will report something like the following:

Next, we will build the Docker image and name it product-service, as follows:

cd microservices/product-service

docker build -t product-service .</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1 has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-425">
<h2 id="_starting_up_docker">15. Starting up Docker</h2>
<div class="sectionbody">
<div class="listingblock has-source-line data-line-/Users/jonny/Code/hands-on-microservice/documents/microservice.adoc-428">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="terminal">docker run --rm -p8080:8080 -e &quot;SPRING_PROFILES_ACTIVE=docker&quot; product-service


1. docker run: The Docker run command will start the container and display log output in Terminal. Terminal will be locked as long as the container runs.

2. We have seen the --rm option already; it will tell Docker to clean up the container once we stop the execution from Terminal using Ctrl + C.

3.The -p8080:8080 option maps port 8080 in the container to port 8080 in the Docker host, which makes it possible to call it from the outside. In the case of Docker for macOS, which runs Docker in a local Linux virtual machine, the port will also be port-forwarded to macOS, which is made available on localhost. We can only have one container mapping to a specific port in the Docker host!

4.With the -e option, we can specify environment variables for the container, which in this case is SPRING_PROFILES_ACTIVE=docker. The SPRING_PROFILES_ACTIVE environment variable is used to tell Spring what profile to use. In our case, we want Spring to use the docker profile.

5. Finally, we have product-service, which is the name of the Docker image that Docker will use to start the container.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
 2020-03-20 13:36:59 +0700
</div>
</div>
</body>
</html>